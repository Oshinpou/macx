<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Global Image Uploader with Tokens (P2P GUN.js)</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      padding: 20px;
    }
    h2 { color: #333; }
    input[type="file"] {
      margin: 10px 0;
    }
    .img-box {
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 15px;
    }
    .img-box img {
      max-width: 100%;
      height: auto;
      display: block;
      margin-top: 10px;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>

<h2>Global Image Upload via Token (GUN.js)</h2>

<input type="file" id="imageInput" accept="image/*">
<button onclick="uploadImage()">Upload Image</button>
<p class="error" id="errorLog"></p>

<div id="uploadedImages"></div>

<!-- GUN.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>

<!-- Inline nanoid-like token generator -->
<script>
  function nanoid(size = 8) {
    const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
    let id = '';
    for (let i = 0; i < size; i++) {
      id += chars[Math.floor(Math.random() * chars.length)];
    }
    return id;
  }
</script>

<script>
  const gun = Gun('https://gun-manhattan.herokuapp.com/gun');
  const uploadedImages = document.getElementById('uploadedImages');
  const errorLog = document.getElementById('errorLog');

  // Display previously uploaded images
  gun.get('images').map().once((data, key) => {
    if (data && data.base64) {
      showImage(key, data.base64);
    }
  });

  function uploadImage() {
    const fileInput = document.getElementById('imageInput');
    const file = fileInput.files[0];
    errorLog.textContent = "";

    if (!file) {
      errorLog.textContent = "Please select an image.";
      return;
    }

    const reader = new FileReader();
    reader.onload = function () {
      try {
        const base64 = reader.result;

        if (!base64.startsWith("data:image/")) {
          throw new Error("Invalid image format.");
        }

        const token = nanoid();
        console.log("Uploading image with token:", token);

        gun.get('images').get(token).put({ base64 }, ack => {
          if (ack.err) {
            console.error("Upload failed:", ack.err);
            errorLog.textContent = "Error: Failed to upload image. " + ack.err;
          } else {
            showImage(token, base64);
          }
        });

      } catch (err) {
        console.error("Upload error:", err);
        errorLog.textContent = "Error: " + err.message;
      }
    };
    reader.onerror = () => {
      console.error("Reader failed:", reader.error);
      errorLog.textContent = "Error: Could not read image file.";
    };
    reader.readAsDataURL(file);
  }

  function showImage(token, base64) {
    const link = `${location.origin + location.pathname}?token=${token}`;
    const box = document.createElement("div");
    box.className = "img-box";
    box.innerHTML = `
      <strong>Token:</strong> ${token}<br>
      <strong>URL:</strong> <a href="${link}" target="_blank">${link}</a><br>
      <button onclick="deleteImage('${token}', this)">Delete Image</button>
      <img src="${base64}" alt="Uploaded Image">
    `;
    uploadedImages.prepend(box);
  }

  function deleteImage(token, button) {
    if (confirm("Are you sure you want to delete this image?") && confirm("Please confirm again to delete.")) {
      gun.get('images').get(token).put(null, ack => {
        if (ack.err) {
          alert("Failed to delete image: " + ack.err);
        } else {
          button.parentElement.remove();
          alert("Image deleted.");
        }
      });
    }
  }

  // If token is in URL, load and show that image
  const urlParams = new URLSearchParams(window.location.search);
  const tokenParam = urlParams.get('token');
  if (tokenParam) {
    gun.get('images').get(tokenParam).once(data => {
      if (data && data.base64) {
        showImage(tokenParam, data.base64);
      } else {
        errorLog.textContent = "No image found for token: " + tokenParam;
      }
    });
  }
</script>

</body>
  </html>
