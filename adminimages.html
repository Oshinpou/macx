<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Images | MACX</title>
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 20px;
      text-align: center;
    }
    h2 { color: #333; }
    #imageInput {
      margin: 20px auto;
      display: block;
    }
    .image-block {
      display: inline-block;
      margin: 15px;
      border: 1px solid #ccc;
      padding: 10px;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .image-block img {
      max-height: 100px;
      display: block;
      margin-bottom: 5px;
    }
    .url {
      font-size: 12px;
      color: #555;
      word-break: break-all;
    }
    button {
      padding: 5px 10px;
      margin-top: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>MACX Admin Image Uploader</h2>
  <p>Upload compatible image files. Each image gets a short unique URL and is visible across all devices globally.</p>
  <input type="file" id="imageInput" accept="image/*" />
  <div id="images"></div>

  <script>
    // Local PouchDB
    const db = new PouchDB("macx-admin-images");

    // Optional: Global sync via CouchDB
    const remote = new PouchDB("https://your-couchdb-url.com/macx-admin-images");
    db.sync(remote, { live: true, retry: true });

    // Upload image
    document.getElementById("imageInput").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async () => {
        const id = "img_" + Math.random().toString(36).substring(2, 7); // Short ID
        try {
          const doc = await db.put({ _id: id, createdAt: new Date().toISOString() });
          await db.putAttachment(id, file.name, doc.rev, reader.result, file.type);
          showImages();
        } catch (err) {
          console.error("Upload error:", err);
        }
      };
      reader.readAsArrayBuffer(file);
    });

    // Show images
    async function showImages() {
      const container = document.getElementById("images");
      container.innerHTML = "";
      const result = await db.allDocs({ include_docs: true });
      for (const row of result.rows) {
        const id = row.id;
        const doc = row.doc;
        const attachments = doc._attachments || {};
        const name = Object.keys(attachments)[0];
        if (!name) continue;

        const blob = await db.getAttachment(id, name);
        const url = URL.createObjectURL(blob);

        const div = document.createElement("div");
        div.className = "image-block";
        div.innerHTML = `
          <img src="${url}" />
          <div class="url">/img/${id}</div>
          <button onclick="deleteImage('${id}')">Delete</button>
        `;
        container.appendChild(div);
      }
    }

    // Delete image
    async function deleteImage(id) {
      try {
        const doc = await db.get(id);
        await db.remove(doc);
        showImages();
      } catch (err) {
        console.error("Delete error:", err);
      }
    }

    showImages();
  </script>
</body>
</html>
